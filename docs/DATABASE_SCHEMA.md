# Database Schema Documentation

**Project**: Retell Metrics Multi-Tenant System  
**Database**: Supabase PostgreSQL  
**Last Updated**: October 3, 2025  
**Generated By**: Comprehensive Database Audit

---

## Table of Contents

1. [Overview](#overview)
2. [Schema Architecture](#schema-architecture)
3. [System Schema](#system-schema)
4. [Organization-Specific Schemas](#organization-specific-schemas)
5. [RPC Functions](#rpc-functions)
6. [Indexes & Performance](#indexes--performance)
7. [Data Statistics](#data-statistics)
8. [Security & RLS](#security--rls)

---

## Overview

The database follows a **multi-tenant architecture** using **PostgreSQL schemas** for data isolation. Each organization gets its own dedicated schema containing isolated call data, while system-wide data is stored in the `system` schema.

### Key Design Principles

- **Data Isolation**: Each organization's data is in a separate PostgreSQL schema
- **Security**: Row Level Security (RLS) and SECURITY DEFINER functions
- **Performance**: Comprehensive indexing strategy for fast queries
- **Scalability**: Schema-per-tenant approach scales horizontally

---

## Schema Architecture

### Available Schemas

| Schema Name | Purpose | Access Level |
|-------------|---------|--------------|
| `system` | Stores organization metadata, users, billing | Service role only |
| `public` | RPC functions and shared utilities | Public (via RPC) |
| `org_[slug]_[hash]` | Organization-specific call data | Organization users only |
| `auth` | Supabase authentication (managed) | Supabase internal |
| `storage` | Supabase storage (managed) | Supabase internal |
| `realtime` | Supabase realtime (managed) | Supabase internal |

### Multi-Tenant Pattern

```
┌──────────────────────────────────────────────┐
│ system schema                                │
│  └─ organizations table (master registry)   │
│  └─ organization_users table                │
│  └─ billing_history table                   │
│  └─ activity_logs table                     │
└──────────────────────────────────────────────┘
                    │
        ┌───────────┼───────────┐
        ▼           ▼           ▼
┌───────────┐ ┌───────────┐ ┌───────────┐
│ org_abc   │ │ org_xyz   │ │ org_123   │
│  └─ calls │ │  └─ calls │ │  └─ calls │
│  └─ call_ │ │  └─ call_ │ │  └─ call_ │
│    rollups│ │    rollups│ │    rollups│
└───────────┘ └───────────┘ └───────────┘
```

---

## System Schema

The `system` schema contains all organization-level metadata and system-wide tables.

### `system.organizations`

**Purpose**: Master registry of all organizations in the platform

| Column | Type | Nullable | Default | Description |
|--------|------|----------|---------|-------------|
| `id` | UUID | NO | `gen_random_uuid()` | Primary key |
| `name` | TEXT | NO | - | Organization display name |
| `slug` | TEXT | NO | - | URL-safe identifier (unique) |
| `subdomain` | TEXT | NO | - | Subdomain for multi-tenant routing (unique) |
| `domain` | TEXT | YES | - | Custom domain (if configured) |
| `schema_name` | TEXT | NO | - | PostgreSQL schema name (unique) |
| `retell_api_key` | TEXT | YES | - | Encrypted Retell API key |
| `retell_agent_id` | TEXT | YES | - | Retell agent identifier |
| `retell_configured` | BOOLEAN | YES | `false` | Retell integration status |
| `cogs_per_minute` | NUMERIC | YES | `0.20` | Cost of goods sold per minute |
| `billing_rate_per_minute` | NUMERIC | YES | `0.40` | Billing rate per minute |
| `branding` | JSONB | YES | See below | White-label branding config |
| `status` | TEXT | YES | `'active'` | Organization status (active/suspended/deleted) |
| `created_at` | TIMESTAMP WITH TIME ZONE | YES | `now()` | Creation timestamp |
| `updated_at` | TIMESTAMP WITH TIME ZONE | YES | `now()` | Last update timestamp |
| `last_activity_at` | TIMESTAMP WITH TIME ZONE | YES | `now()` | Last activity timestamp |

**Indexes**:
- `PRIMARY KEY (id)`
- `UNIQUE (slug)`
- `UNIQUE (subdomain)`
- `UNIQUE (schema_name)`
- `INDEX idx_organizations_slug (slug)`
- `INDEX idx_organizations_subdomain (subdomain)`
- `INDEX idx_organizations_status (status)`

**Branding JSONB Default**:
```json
{
  "logo_url": null,
  "favicon_url": null,
  "company_name": null,
  "primary_color": "#3B82F6",
  "secondary_color": "#1E40AF"
}
```

**Row Count**: 3 organizations

### `system.organization_users`

**Purpose**: Maps Supabase Auth users to organizations with roles

| Column | Type | Nullable | Description |
|--------|------|----------|-------------|
| `id` | UUID | NO | Primary key |
| `organization_id` | UUID | NO | Foreign key to organizations |
| `user_id` | UUID | NO | Foreign key to auth.users |
| `role` | TEXT | NO | User role (org_admin, viewer, etc.) |
| `created_at` | TIMESTAMP WITH TIME ZONE | YES | Creation timestamp |
| `updated_at` | TIMESTAMP WITH TIME ZONE | YES | Last update timestamp |

**Note**: Currently managed via Supabase Auth `user_metadata` field

### `system.billing_history`

**Purpose**: Tracks billing events and transactions

| Column | Type | Description |
|--------|------|-------------|
| `id` | UUID | Primary key |
| `organization_id` | UUID | Foreign key to organizations |
| `period_start` | TIMESTAMP WITH TIME ZONE | Billing period start |
| `period_end` | TIMESTAMP WITH TIME ZONE | Billing period end |
| `total_minutes` | NUMERIC | Total billable minutes |
| `total_cost` | NUMERIC | Total cost for period |
| `status` | TEXT | Payment status |
| `created_at` | TIMESTAMP WITH TIME ZONE | Creation timestamp |

### `system.activity_logs`

**Purpose**: Audit trail for system-wide activities

| Column | Type | Description |
|--------|------|-------------|
| `id` | UUID | Primary key |
| `organization_id` | UUID | Foreign key to organizations (nullable) |
| `user_id` | UUID | Foreign key to auth.users (nullable) |
| `action` | TEXT | Action performed |
| `resource_type` | TEXT | Type of resource affected |
| `resource_id` | TEXT | ID of resource affected |
| `metadata` | JSONB | Additional context |
| `created_at` | TIMESTAMP WITH TIME ZONE | Timestamp |

### `system.system_users`

**Purpose**: Internal system users (super admins)

| Column | Type | Description |
|--------|------|-------------|
| `id` | UUID | Primary key |
| `email` | TEXT | Email address |
| `role` | TEXT | System role (super_admin) |
| `created_at` | TIMESTAMP WITH TIME ZONE | Creation timestamp |

---

## Organization-Specific Schemas

Each organization has a dedicated PostgreSQL schema with the naming pattern:

```
org_[slug]_[hash]
```

**Example**: `org_thecreativehorse_3cbe86ec52774832a9185220c74fc619`

### `[org_schema].calls`

**Purpose**: Stores all call records for a specific organization

| Column | Type | Nullable | Default | Description |
|--------|------|----------|---------|-------------|
| `id` | UUID | NO | `gen_random_uuid()` | Internal primary key |
| `external_call_id` | TEXT | NO | - | Retell call ID (unique) |
| `started_at` | TIMESTAMP WITH TIME ZONE | YES | - | Call start time |
| `connected_at` | TIMESTAMP WITH TIME ZONE | YES | - | Call connection time |
| `ended_at` | TIMESTAMP WITH TIME ZONE | YES | - | Call end time |
| `direction` | TEXT | YES | - | Call direction (inbound/outbound) |
| `from_e164` | TEXT | YES | - | Caller phone number (E.164 format) |
| `to_e164` | TEXT | YES | - | Recipient phone number (E.164 format) |
| `status` | TEXT | YES | - | Call status (completed, failed, etc.) |
| `end_reason` | TEXT | YES | - | Reason for call termination |
| `duration_seconds` | INTEGER | YES | - | Call duration in seconds |
| `billed_minutes` | NUMERIC | YES | - | Billable minutes (rounded up) |
| `outcome` | TEXT | YES | - | Call outcome classification |
| `detailed_summary` | TEXT | YES | - | AI-generated call summary |
| `transcript` | TEXT | YES | - | Full call transcript |
| `raw` | JSONB | YES | - | Raw Retell webhook data |
| `created_at` | TIMESTAMP WITH TIME ZONE | YES | `now()` | Record creation time |
| `updated_at` | TIMESTAMP WITH TIME ZONE | YES | `now()` | Record update time |
| `organization_id` | UUID | YES | - | Foreign key to system.organizations |
| `agent_id` | TEXT | YES | - | Retell agent ID |

**Indexes** (for performance):
- `PRIMARY KEY (id)`
- `UNIQUE (external_call_id)`
- `INDEX idx_calls_created_at (created_at DESC)` - For pagination
- `INDEX idx_calls_started_at (started_at DESC)` - For date queries
- `INDEX idx_calls_status (status)` - For filtering by status
- `INDEX idx_calls_agent_id (agent_id)` - For agent-specific queries
- `INDEX idx_calls_org_id (organization_id)` - For org filtering
- `INDEX idx_calls_date_status (created_at DESC, status)` - Composite index
- `INDEX idx_calls_raw_gin (raw)` - GIN index for JSONB queries
- `INDEX idx_calls_external_id (external_call_id)` - Duplicate for safety

**Row Count** (TheCreativeHorse): 26 calls

### `[org_schema].call_rollups`

**Purpose**: Pre-aggregated call metrics by day/agent (future use)

| Column | Type | Description |
|--------|------|-------------|
| `id` | UUID | Primary key |
| `day` | DATE | Aggregation day |
| `agent_id` | TEXT | Agent identifier |
| `organization_id` | UUID | Organization ID |
| `total_calls` | INTEGER | Total calls for day |
| `successful_calls` | INTEGER | Successful calls |
| `failed_calls` | INTEGER | Failed calls |
| `total_duration_seconds` | INTEGER | Sum of durations |
| `total_billed_minutes` | NUMERIC | Sum of billed minutes |
| `created_at` | TIMESTAMP WITH TIME ZONE | Creation timestamp |
| `updated_at` | TIMESTAMP WITH TIME ZONE | Update timestamp |

**Indexes**:
- `PRIMARY KEY (id)`
- `UNIQUE (day, agent_id, organization_id)`
- `INDEX idx_call_rollups_day (day DESC)`

---

## RPC Functions

All RPC functions are in the `public` schema and marked as `SECURITY DEFINER` to bypass RLS.

### Organization Management

#### `public.create_organization()`

**Purpose**: Creates a new organization and its schema

**Parameters**:
```sql
p_name TEXT,
p_retell_api_key TEXT,
p_retell_agent_id TEXT
```

**Returns**: `TABLE (id UUID, name TEXT, schema_name TEXT)`

**Example**:
```sql
SELECT * FROM public.create_organization(
  p_name := 'Acme Corp',
  p_retell_api_key := 'key_abc123',
  p_retell_agent_id := 'agent_xyz789'
);
```

#### `public.list_organizations()`

**Purpose**: Lists all organizations (super admin only)

**Parameters**: None

**Returns**: `TABLE (id UUID, name TEXT, slug TEXT, schema_name TEXT, status TEXT, created_at TIMESTAMP WITH TIME ZONE)`

**Example**:
```sql
SELECT * FROM public.list_organizations();
```

#### `public.create_organization_schema()`

**Purpose**: Creates tables and policies for a new organization schema

**Parameters**:
```sql
p_org_id UUID,
p_schema_name TEXT
```

**Returns**: `BOOLEAN` (success/failure)

**What it creates**:
- `calls` table
- `call_rollups` table
- RLS policies
- Indexes

### Call Data Retrieval

#### `public.get_organization_calls()`

**Purpose**: Retrieves calls for an organization with cursor-based pagination

**Parameters**:
```sql
p_org_id UUID,
p_limit INTEGER DEFAULT 50,
p_cursor TIMESTAMP WITH TIME ZONE DEFAULT NULL,
p_from_date TIMESTAMP WITH TIME ZONE DEFAULT NULL,
p_to_date TIMESTAMP WITH TIME ZONE DEFAULT NULL
```

**Returns**: `TABLE` (all call columns + pagination metadata)
- `has_more BOOLEAN` - Whether more results exist
- `next_cursor TIMESTAMP WITH TIME ZONE` - Cursor for next page

**Example**:
```sql
-- First page
SELECT * FROM public.get_organization_calls(
  p_org_id := 'a532b854-cbee-42f8-a669-cc6dfaa753aa',
  p_limit := 10
);

-- Next page
SELECT * FROM public.get_organization_calls(
  p_org_id := 'a532b854-cbee-42f8-a669-cc6dfaa753aa',
  p_limit := 10,
  p_cursor := '2025-10-02T01:27:10.865502+00:00'
);
```

**Performance**: Uses `idx_calls_created_at` for fast cursor-based pagination

#### `public.get_organization_overview()`

**Purpose**: Gets aggregated metrics for an organization

**Parameters**:
```sql
p_org_id UUID,
p_from_date TIMESTAMP WITH TIME ZONE DEFAULT NULL,
p_to_date TIMESTAMP WITH TIME ZONE DEFAULT NULL
```

**Returns**: `TABLE`
- `total_calls INTEGER`
- `successful_calls INTEGER`
- `failed_calls INTEGER`
- `total_duration INTEGER`
- `total_billed_minutes NUMERIC`
- `avg_duration NUMERIC`
- `avg_billed_minutes NUMERIC`

**Example**:
```sql
SELECT * FROM public.get_organization_overview(
  p_org_id := 'a532b854-cbee-42f8-a669-cc6dfaa753aa',
  p_from_date := '2025-09-01T00:00:00Z',
  p_to_date := '2025-09-30T23:59:59Z'
);
```

### Data Migration

#### `public.migrate_calls_to_organization()`

**Purpose**: Migrates calls from old single-tenant structure to organization schema

**Parameters**:
```sql
p_org_id UUID
```

**Returns**: `INTEGER` (number of migrated calls)

**Note**: Used during initial multi-tenant setup

#### `public.fix_organization_schema()`

**Purpose**: Fixes missing columns in existing organization schemas

**Parameters**:
```sql
p_org_id UUID
```

**Returns**: `BOOLEAN`

---

## Indexes & Performance

### System Schema Indexes

**system.organizations**:
- ✅ Primary key on `id`
- ✅ Unique constraint + index on `slug`
- ✅ Unique constraint + index on `subdomain`
- ✅ Unique constraint + index on `schema_name`
- ✅ Index on `status` for filtering active orgs

### Organization Schema Indexes

Applied to **every** organization's `calls` table:

1. **Primary & Unique**:
   - `calls_pkey (id)` - Primary key
   - `calls_external_call_id_key (external_call_id)` - Prevent duplicates

2. **Date & Time Queries**:
   - `idx_calls_created_at (created_at DESC)` - Pagination & recent calls
   - `idx_calls_started_at (started_at DESC)` - Time-based queries
   - `idx_calls_date_status (created_at DESC, status)` - Composite for filtered queries

3. **Filtering Indexes**:
   - `idx_calls_status (status)` - Filter by call outcome
   - `idx_calls_agent_id (agent_id)` - Agent-specific queries
   - `idx_calls_org_id (organization_id)` - Organization filtering

4. **JSONB Search**:
   - `idx_calls_raw_gin (raw)` - GIN index for JSON queries

### Index Performance Impact

With proper indexes, queries scale logarithmically:
- **26 calls**: 0.146 ms execution time
- **1,000 calls**: ~1-2 ms (estimated)
- **100,000 calls**: ~5-10 ms (estimated)
- **1,000,000 calls**: ~15-25 ms (estimated)

**Key**: Cursor-based pagination avoids `OFFSET` performance degradation

---

## Data Statistics

### Current Database Size

| Metric | Value |
|--------|-------|
| Total Organizations | 3 |
| Active Organizations | 3 |
| Test Organizations | 2 (Test Org, Test Organization) |
| Production Organizations | 1 (TheCreativeHorse) |
| Total Calls (TheCreativeHorse) | 26 |
| Total Calls (All Orgs) | 26+ |

### Organization Breakdown

| Organization | Slug | Schema | Status | Created |
|--------------|------|--------|--------|---------|
| TheCreativeHorse | thecreativehorse | org_thecreativehorse_... | active | 2025-10-02 |
| Test Organization | test-organization | org_test-organization_... | active | 2025-10-03 |
| Test Org | test-org | org_test-org_... | active | 2025-10-03 |

---

## Security & RLS

### Row Level Security (RLS)

**Status**: ✅ Enabled on organization-specific schemas

**Policies**:

1. **Service Role Access**: Full access for backend service
   ```sql
   CREATE POLICY "Service role access"
   ON [org_schema].calls
   FOR ALL
   TO service_role
   USING (true);
   ```

2. **Organization User Access** (planned):
   ```sql
   CREATE POLICY "Organization user access"
   ON [org_schema].calls
   FOR SELECT
   TO authenticated
   USING (organization_id = auth.user_metadata()->>'organization_id');
   ```

### Authentication Model

**User Metadata** (stored in Supabase Auth):
```json
{
  "role": "org_admin",
  "organization_id": "a532b854-cbee-42f8-a669-cc6dfaa753aa",
  "first_name": "Admin",
  "last_name": "User"
}
```

**Roles**:
- `super_admin` - Full platform access
- `org_admin` - Organization administration
- `viewer` - Read-only access (future)

### Data Encryption

**Encrypted Fields**:
- `system.organizations.retell_api_key` - AES-256-CBC encryption
- Encryption key stored in `ENCRYPTION_KEY` environment variable

**Encryption Process**:
1. Generate IV (Initialization Vector)
2. Encrypt with AES-256-CBC
3. Store as `iv:encrypted_data` format
4. Decrypt on retrieval

---

## Best Practices

### Querying Data

**✅ DO**:
- Use RPC functions for cross-schema queries
- Always use cursor-based pagination for large datasets
- Filter by indexed columns (`created_at`, `status`, `agent_id`)
- Use date ranges to limit query scope

**❌ DON'T**:
- Don't use `OFFSET` for pagination (use cursors instead)
- Don't query without date filters on large tables
- Don't access organization schemas directly from client
- Don't hardcode organization IDs in client code

### Schema Management

**✅ DO**:
- Use `create_organization_schema()` for new organizations
- Apply indexes immediately after schema creation
- Test RLS policies before deploying to production

**❌ DON'T**:
- Don't manually create organization schemas
- Don't forget to create indexes
- Don't skip RLS policy creation

### Performance Optimization

1. **Use Indexes**: All date/time queries use indexed columns
2. **Cursor Pagination**: Scales to millions of records
3. **Date Filtering**: Limit queries to specific time ranges
4. **Selective Columns**: Only fetch needed columns in large queries

---

## Migration History

### Phase 1: Single-Tenant
- Single `public.calls` table
- All organizations in one table

### Phase 2: Multi-Tenant (Current)
- **system.organizations** table created
- Organization-specific schemas created
- Data migrated to TheCreativeHorse schema
- RPC functions for cross-schema access
- Cursor-based pagination implemented
- Comprehensive indexing strategy

### Future Phases
- Call rollup aggregations for faster analytics
- Real-time metrics using Supabase Realtime
- Advanced RLS policies for granular permissions
- Archival strategy for old calls

---

## Troubleshooting

### Common Issues

**Issue**: "Organization not found"  
**Solution**: Verify organization exists in `system.organizations`

**Issue**: "Could not choose best candidate function"  
**Solution**: Multiple function versions exist, drop old versions first

**Issue**: "Column does not exist"  
**Solution**: Run `fix_organization_schema()` to add missing columns

**Issue**: Slow queries  
**Solution**: Check `EXPLAIN ANALYZE` output, ensure indexes are used

### Useful Queries

**Check organization schemas**:
```sql
SELECT id, name, schema_name 
FROM system.organizations 
ORDER BY created_at DESC;
```

**Verify indexes exist**:
```sql
SELECT indexname, indexdef 
FROM pg_indexes 
WHERE schemaname = 'org_thecreativehorse_3cbe86ec52774832a9185220c74fc619';
```

**Check call count per organization**:
```sql
SELECT 
  o.name,
  (SELECT COUNT(*) FROM org_thecreativehorse_3cbe86ec52774832a9185220c74fc619.calls) as call_count
FROM system.organizations o
WHERE o.slug = 'thecreativehorse';
```

---

## Appendix: Entity Relationship Diagram

```
┌─────────────────────────┐
│ system.organizations    │
│─────────────────────────│
│ • id (PK)              │
│ • name                  │
│ • slug (UNIQUE)         │
│ • schema_name (UNIQUE)  │
│ • retell_api_key (ENC)  │
│ • retell_agent_id       │
│ • branding (JSONB)      │
│ • status                │
└─────────────────────────┘
           │
           │ 1:N
           ▼
┌─────────────────────────┐
│ [org].calls             │
│─────────────────────────│
│ • id (PK)              │
│ • external_call_id (UK) │
│ • started_at            │
│ • ended_at              │
│ • duration_seconds      │
│ • status                │
│ • transcript (TEXT)     │
│ • raw (JSONB)           │
│ • organization_id (FK)  │
│ • agent_id              │
└─────────────────────────┘
```

---

**Document Version**: 1.0  
**Last Audit**: October 3, 2025  
**Total Tables Documented**: 7  
**Total RPC Functions**: 8  
**Total Indexes**: 18+

